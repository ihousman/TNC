//Module imports
var getImageLib = require('users/USFS_GTAC/modules:getImagesLib.js');
var cd = require('users/USFS_GTAC/modules:changeDetectionLib.js');
cd.getExistingChangeData()
var c = ee.ImageCollection('projects/igde-work/raster-data/composite-collection');
var igdes = ee.FeatureCollection('projects/igde-work/igde-data/iGDE_AnnualDepth_renamed_oct2018_v2');

var ts = c.map(getImageLib.simpleAddIndices).select(['NBR']).map(function(img){return img.clip(igdes)});
Map.addLayer(ts,{},'ts',false);


//Define landtrendr params
var run_params = { 
  maxSegments:            6,
  spikeThreshold:         0.9,
  vertexCountOvershoot:   3,
  preventOneYearRecovery: true,
  recoveryThreshold:      0.25,
  pvalThreshold:          0.05,
  bestModelProportion:    0.75,
  minObservationsNeeded:  6
};

run_params.timeSeries =  ts.map(function(img){return ee.Image(cd.multBands(img,-1,1))});

var lt = ee.Algorithms.TemporalSegmentation.LandTrendr(run_params).select([0]);
Map.addLayer(lt,{},'lt',false);

var vertices = lt.arraySlice(0,3,4);

var fittedC = cd.arrayToTimeSeries(lt.arraySlice(0,2,3).arrayProject([1]).multiply(-1),lt.arraySlice(0,0,1).arrayProject([1]),ee.List.sequence(1985,2018),'NBR')
var joined = getImageLib.joinCollections(ts,fittedC);
Map.addLayer(joined,{},'joined',false)
lt = lt.arrayMask(vertices)
// Map.addLayer(lt)

var left = lt.arraySlice(1,0,-1);
var right = lt.arraySlice(1,1,null);
var diff  = right.subtract(left);

var yearsLeft = left.arraySlice(0,0,1);
var yearsRight = right.arraySlice(0,0,1);
var mag = diff.arraySlice(0,2,3);
var duration = diff.arraySlice(0,0,1);
var slope = mag.divide(duration);
var all = ee.Image.cat([yearsLeft.arrayProject([1]),yearsRight.arrayProject([1]),
          duration.arrayProject([1]),mag.arrayProject([1]),slope.arrayProject([1])])
var sortBy = yearsRight.multiply(-1).arrayProject([1]);
all = all.arraySort(sortBy)
Map.addLayer(all)

var sortedSlope = all.arraySlice(0,3,4)
Map.addLayer(sortedSlope,{},'sortedSlope')

// var slowchange =  slope.gt(0.005).and(duration.gt(5));
// var fastChange =  mag.gt(0.15).and(duration.lte(5));

// // Map.addLayer(slope,{},'slope',false)
// // Map.addLayer(diff,{},'diff',false);
// // Map.addLayer(change,{},'change',false)

// var slowChangeYears = yearsRight.arrayMask(slowchange).arrayReduce(ee.Reducer.max(), [1]).arrayProject([0]).arrayFlatten([['year']]);
// var fastChangeYears = yearsRight.arrayMask(fastChange).arrayReduce(ee.Reducer.max(), [1]).arrayProject([0]).arrayFlatten([['year']]);

// var slowChangeMag = mag.arrayMask(slowchange).arrayReduce(ee.Reducer.max(), [1]).arrayProject([0]).arrayFlatten([['slowChange']]);
// var fastChangeMag = mag.arrayMask(fastChange).arrayReduce(ee.Reducer.max(), [1]).arrayProject([0]).arrayFlatten([['fastChange']]);

// var vizParamsYears = {min:1985,max:2018,palette:'FF0,F00'};
// var vizParamsMag = {min:0.01,max:0.5,palette:'080,F00'};
// Map.addLayer(slowChangeYears.updateMask(slowChangeYears.neq(0)),vizParamsYears,'slowChangeYears',false)
// Map.addLayer(fastChangeYears.updateMask(fastChangeYears.neq(0)),vizParamsYears,'fastChangeYears',false)

// Map.addLayer(slowChangeMag.updateMask(slowChangeYears.neq(0)),vizParamsMag,'slowChangeMag',false)
// Map.addLayer(fastChangeMag.updateMask(fastChangeYears.neq(0)),vizParamsMag,'fastChangeMag',false)
// Map.addLayer(igdes)